{"version":3,"sources":["../src/listenDevices.js"],"names":["usbDetect","ledgerUSBVendorId","log","deviceToLog","productId","locationId","deviceAddress","usbDebounce","setUsbDebounce","n","monitoring","monitor","startMonitoring","process","on","stopMonitoring","listenDevices","onAdd","onRemove","unmonitor","addEvent","removeEvent","timeout","add","device","setTimeout","remove","clearTimeout","off"],"mappings":"AACA,OAAOA,SAAP,MAAsB,eAAtB;AACA,SAASC,iBAAT,QAAkC,mBAAlC;AACA,SAASC,GAAT,QAAoB,gBAApB;;AAYA,MAAMC,WAAW,GAAG,CAAC;AAAEC,EAAAA,SAAF;AAAaC,EAAAA,UAAb;AAAyBC,EAAAA;AAAzB,CAAD,KACjB,aAAYF,SAAU,eAAcC,UAAW,kBAAiBC,aAAc,EADjF;;AAGA,IAAIC,WAAW,GAAG,IAAlB;AAEA,OAAO,MAAMC,cAAc,GAAIC,CAAD,IAAe;AAC3CF,EAAAA,WAAW,GAAGE,CAAd;AACD,CAFM;AAIP,IAAIC,UAAU,GAAG,KAAjB;;AACA,MAAMC,OAAO,GAAG,MAAM;AACpB,MAAI,CAACD,UAAL,EAAiB;AACfA,IAAAA,UAAU,GAAG,IAAb;AACAV,IAAAA,SAAS,CAACY,eAAV;AACD;;AACD,SAAO,MAAM,CAAE,CAAf;AACD,CAND,C,CAQA;;;AACAC,OAAO,CAACC,EAAR,CAAW,MAAX,EAAmB,MAAM;AACvB,MAAIJ,UAAJ,EAAgB;AACd;AACAV,IAAAA,SAAS,CAACe,cAAV;AACD;AACF,CALD;AAOA,OAAO,MAAMC,aAAa,GAAG,CAC3BC,KAD2B,EAE3BC,QAF2B,KAGxB;AACH,QAAMC,SAAS,GAAGR,OAAO,EAAzB;AAEA,QAAMS,QAAQ,GAAG,SAASnB,iBAA1B;AACA,QAAMoB,WAAW,GAAG,YAAYpB,iBAAhC;AAEA,MAAIqB,OAAJ;;AAEA,QAAMC,GAAG,GAAIC,MAAD,IAAY;AACtBtB,IAAAA,GAAG,CAAC,eAAD,EAAkB,UAAUC,WAAW,CAACqB,MAAD,CAAvC,CAAH;;AACA,QAAI,CAACF,OAAL,EAAc;AACZ;AACA;AACAA,MAAAA,OAAO,GAAGG,UAAU,CAAC,MAAM;AACzBR,QAAAA,KAAK,CAACO,MAAD,CAAL;AACAF,QAAAA,OAAO,GAAG,IAAV;AACD,OAHmB,EAGjBf,WAHiB,CAApB;AAID;AACF,GAVD;;AAYA,QAAMmB,MAAM,GAAIF,MAAD,IAAY;AACzBtB,IAAAA,GAAG,CAAC,eAAD,EAAkB,aAAaC,WAAW,CAACqB,MAAD,CAA1C,CAAH;;AACA,QAAIF,OAAJ,EAAa;AACXK,MAAAA,YAAY,CAACL,OAAD,CAAZ;AACAA,MAAAA,OAAO,GAAG,IAAV;AACD,KAHD,MAGO;AACLJ,MAAAA,QAAQ,CAACM,MAAD,CAAR;AACD;AACF,GARD;;AAUAxB,EAAAA,SAAS,CAACc,EAAV,CAAaM,QAAb,EAAuBG,GAAvB;AACAvB,EAAAA,SAAS,CAACc,EAAV,CAAaO,WAAb,EAA0BK,MAA1B;AAEA,SAAO,MAAM;AACX,QAAIJ,OAAJ,EAAaK,YAAY,CAACL,OAAD,CAAZ;AACbtB,IAAAA,SAAS,CAAC4B,GAAV,CAAcR,QAAd,EAAwBG,GAAxB;AACAvB,IAAAA,SAAS,CAAC4B,GAAV,CAAcP,WAAd,EAA2BK,MAA3B;AACAP,IAAAA,SAAS;AACV,GALD;AAMD,CA1CM","sourcesContent":["// @flow\nimport usbDetect from \"usb-detection\";\nimport { ledgerUSBVendorId } from \"@ledgerhq/devices\";\nimport { log } from \"@ledgerhq/logs\";\n\nexport type Device = {\n  locationId: number,\n  vendorId: number,\n  productId: number,\n  deviceName: string,\n  manufacturer: string,\n  serialNumber: string,\n  deviceAddress: number,\n};\n\nconst deviceToLog = ({ productId, locationId, deviceAddress }) =>\n  `productId=${productId} locationId=${locationId} deviceAddress=${deviceAddress}`;\n\nlet usbDebounce = 1000;\n\nexport const setUsbDebounce = (n: number) => {\n  usbDebounce = n;\n};\n\nlet monitoring = false;\nconst monitor = () => {\n  if (!monitoring) {\n    monitoring = true;\n    usbDetect.startMonitoring();\n  }\n  return () => {};\n};\n\n// No better way for now. see https://github.com/LedgerHQ/ledgerjs/issues/434\nprocess.on(\"exit\", () => {\n  if (monitoring) {\n    // redeem the monitoring so the process can be terminated.\n    usbDetect.stopMonitoring();\n  }\n});\n\nexport const listenDevices = (\n  onAdd: (Device) => void,\n  onRemove: (Device) => void\n) => {\n  const unmonitor = monitor();\n\n  const addEvent = \"add:\" + ledgerUSBVendorId;\n  const removeEvent = \"remove:\" + ledgerUSBVendorId;\n\n  let timeout;\n\n  const add = (device) => {\n    log(\"usb-detection\", \"add: \" + deviceToLog(device));\n    if (!timeout) {\n      // a time is needed for the device to actually be connectable over HID..\n      // we also take this time to not emit the device yet and potentially cancel it if a remove happens.\n      timeout = setTimeout(() => {\n        onAdd(device);\n        timeout = null;\n      }, usbDebounce);\n    }\n  };\n\n  const remove = (device) => {\n    log(\"usb-detection\", \"remove: \" + deviceToLog(device));\n    if (timeout) {\n      clearTimeout(timeout);\n      timeout = null;\n    } else {\n      onRemove(device);\n    }\n  };\n\n  usbDetect.on(addEvent, add);\n  usbDetect.on(removeEvent, remove);\n\n  return () => {\n    if (timeout) clearTimeout(timeout);\n    usbDetect.off(addEvent, add);\n    usbDetect.off(removeEvent, remove);\n    unmonitor();\n  };\n};\n"],"file":"listenDevices.js"}